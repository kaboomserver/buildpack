#!/bin/sh
PATH="$HOME/java/bin/:$HOME/tmux/bin/:$PATH"

echo "$REMOTE_KEY" > .ssh/remote
echo "$SYNC_KEY" > .ssh/id_rsa
chmod 600 .ssh/remote

ssh-keyscan framagit.org >> .ssh/known_hosts
ssh-keyscan play.kaboom.pw >> .ssh/known_hosts

chmod -R 500 plugins/bStats/ plugins/PluginMetrics/ plugins/ProtocolLib/

git clone git@framagit.org:kaboom/core/schematics.git plugins/WorldEdit/schematics/

tmux new -d -s server 'while true; do
	java -Xmx384M -Xss512k -Xaggressive -Xdump:none -Xquickstart -Xshareclasses -XX:MaxDirectMemorySize=384M -XX:-HeapDumpOnOutOfMemoryError -XX:+IdleTuningGcOnIdle -XX:+UseContainerSupport -Dcom.mojang.eula.agree=true -jar minecraft-server.jar --world-dir=worlds
	sleep 1
done'

tmux new -d -s remote 'while true; do
	ssh -i ~/.ssh/remote -o Compression=no -o ExitOnForwardFailure=yes -o StreamLocalBindUnlink=yes -c aes128-ctr -S none -N -T -R 5930:localhost:25565 -p 5950 remote@play.kaboom.pw
	sleep 1
done'

tmux new -d -s schematics 'while true; do
	cd $HOME/plugins/WorldEdit/schematics/
	if [ "$(git add $(git ls-files -o) -v)" ]; then
		git -c user.name='kaboom' -c user.email='kaboom.pw' commit -m "Add new schematics"
		git push
	fi
	sleep 1
done'

sleep 60

while true; do
	sleep 120
	if [ "$(env printf '\xFE' | nc -w 5 localhost 25565 | wc -m)" -eq 0 ]; then
		kill -9 $(pgrep java)
	fi
done &

sleep infinity
